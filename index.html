<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIG Centro Holístico de Estudios Territoriales</title>

    <!-- ArcGIS JS API CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ArcGIS JS API -->
    <script src="https://js.arcgis.com/4.26/"></script>

    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <link rel="icon" href="https://centroholisticoestudiosterritoriales.com/images/LOGO_CHET_vect_clip.png" type="image/png" sizes="32x32">

    <style>
        /* Estilos generales */
        html, body, #viewDiv {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* Estilos del modal */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 600px;
            text-align: center;
        }

        .modal h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal p {
            font-size: 1rem;
            margin-bottom: 1rem;
            text-align: justify;
        }

        .modal button {
            padding: 10px 20px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal button:hover {
            background-color: #005a9e;
        }

        /* Botones personalizados */
        .custom-button {
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 33px;
            height: 33px;
        }

        .custom-button:hover {
            background: #f0f0f0;
        }

        /* Botones en columna vertical */
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: absolute;
            bottom: 20px;
            left: 15px;
        }

        /* Ajustes para impresión */
        @media print {
            body, html {
                height: auto;
            }
            #viewDiv {
                width: 100vw;
                height: 100vh;
                position: absolute;
                top: 0;
                left: 0;
            }
        }

        /* Mapa Capturado para impresión */
        .map-container {
            display: none;
            width: 100%;
            height: 100%;
        }

        .print-map {
            display: block !important;
            width: 100%;
            height: 100%;
        }

        /* Estilos del formulario de contacto */
        .contact-form {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        .contact-form input, .contact-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .contact-form button {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .contact-form button:hover {
            background-color: #45a049;
        }

        /* Selector de mapa base */
        .basemap-selector {
            display: none;
            position: absolute;
            bottom: 80px;
            left: 15px;
            z-index: 999;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .basemap-selector button {
            width: 100%;
            padding: 10px;
            border: none;
            background: #fff;
            cursor: pointer;
        }

        .basemap-selector button:hover {
            background: #f0f0f0;
        }

/* Logo */
        .logo-box {
            position: absolute;
            bottom: 57px; /* Ajusta la posición vertical del logo */
            right: 20px; /* Ajusta la posición horizontal del logo */
            z-index: 10; /* Asegura que el logo esté por encima de otros elementos */
        }

        .logo-box img {
            width: 70px; /* Ajusta el tamaño del logo según sea necesario */
            height: auto; /* Mantiene la proporción de la imagen */
        }

        /* Coordenadas y escala */
       .coordinates-box, .scale-box {
            position: absolute;
            background-color: white;
            padding: 2px;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
           font-size: 11px;
           z-index: 10;
        }

       .coordinates-box {
            bottom: 20px;
            right: 10px;
        }

       .scale-box {
            bottom: 42px;
            right: 10px;
        }

        /* Botón de medición */
        #toggleMeasurementBtn {
            position: absolute;
            bottom: 280px;
            left: 15px;
        }

        /* Botón de capas */
        #toggleLayerList {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 999;
            background-color: #ffffff;
            border: 1px solid #ccc;
            cursor: pointer;
            border-radius: 5px;
            width: 33px;
            height: 33px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Responsividad */
        @media (max-width: 768px) {
            .button-container {
                bottom: 10px;
                left: 10px;
            }

            .coordinates-box, .scale-box {
                font-size: 10px;
                padding: 3px 6px;
            }

            .modal {
                width: 90%;
                padding: 15px;
            }

            .contact-form {
                width: 90%;
            }
        }
    </style>
	

</head>
<body>

    <!-- Contenedor principal del mapa -->
    <div id="viewDiv"></div>

    <!-- Contenedor de botones -->
    <div class="button-container">
        <button class="custom-button text-gray-500 hover:bg-gray-200" onclick="printMap()">
            <i class="fas fa-print"></i>
        </button>
		
		<button class="custom-button text-gray-500 hover:bg-gray-200" onclick="window.open('https://centroholisticoestudiosterritoriales.com', '_blank');">
            <i class="fas fa-external-link-alt"></i>
        </button>

        <button class="custom-button text-gray-500 hover:bg-gray-200" onclick="toggleContactForm()">
            <i class="fas fa-envelope"></i>
        </button>

		<button class="custom-button text-gray-500 hover:bg-gray-200" onclick="window.open('https://wkkf.maps.arcgis.com/apps/dashboards/b2f6d65637e944c3b3f1b98a054b8eaa', '_blank');">
            <i class="fas fa-chart-line"></i>
        </button>

        <button class="custom-button text-gray-500 hover:bg-gray-200" onclick="shareMap()">
            <i class="fas fa-share-alt"></i>
        </button>

        <button class="custom-button text-gray-500 hover:bg-gray-200" onclick="toggleBasemapGallery()">
            <i class="esri-icon-basemap"></i>
        </button>
    </div>

    <!-- Contenedor para la imagen capturada del mapa -->
    <div id="printMapContainer" class="map-container">
        <img id="printMap" src="" alt="Mapa para imprimir" />
    </div>

    <!-- Formulario de contacto -->
    <div id="contactForm" class="contact-form">
        <h3>Contacto</h3>
        <input type="text" id="name" placeholder="Tu nombre" required>
        <input type="email" id="email" placeholder="Tu correo electrónico" required>
        <textarea id="comments" rows="4" placeholder="Comentarios" required></textarea>
        <button onclick="sendEmail()">Enviar correo</button>
    </div>

    <!-- Panel de selección de mapas base -->
    <div id="basemapSelector" class="basemap-selector"></div>

    <!-- Modal de bienvenida -->
    <div id="welcomeModal" class="modal-container">
        <div class="modal">
            <h1>Mensaje de Bienvenida</h1>
            <p>Bienvenido(a) al Sistema de Información Geográfica del Centro Holístico de Estudios Territoriales. La información presentada en esta plataforma ha sido meticulosamente recopilada, procesada, analizada y puesta a disposición del público con el más alto estándar de excelencia técnica y rigurosidad científica. Es importante destacar que los datos y mapas aquí proporcionados tienen un propósito meramente informativo y educativo.</p>
            <p>Al acceder y utilizar esta aplicación, usted acepta y reconoce que el Centro Holístico de Estudios Territoriales y todos sus colaboradores, socios y patrocinadores quedan exentos de cualquier responsabilidad, obligación o reclamo derivado del uso, interpretación o aplicación indebida de la información aquí contenida. El usuario asume plena responsabilidad por las acciones y decisiones tomadas en función de los datos consultados.</p>
            <p>Para más información sobre nuestros métodos, fuentes y alcance de los estudios, le invitamos a visitar el sitio oficial del <a href="https://centroholisticoestudiosterritoriales.com/" target="_blank" class="text-blue-500 hover:underline">Centro Holístico de Estudios Territoriales</a>.</p>
            <div class="mt-8 mb-8">
                <img src="https://centroholisticoestudiosterritoriales.com/images/LOGO_CHET_vect_clip.png" alt="Imagen descriptiva" class="w-12 h-auto mx-auto">
            </div>
            <button onclick="closeModal()">Acepto los términos y condiciones</button>
        </div>
    </div>

<!-- Logo -->
<div id="logoBox" class="logo-box">
    <img src="https://centroholisticoestudiosterritoriales.com/images/logo_CHETw.png" alt="Logo CHET">
</div>

<!-- Información de coordenadas y escala -->
<div id="coordinatesBox" class="coordinates-box">
    <p id="coordinatesText">Lat: , Lon: </p>
</div>

<div id="scaleBox" class="scale-box">
    <p id="scaleText">Escala: 1: </p>
</div>

    <!-- Botón de medición -->
<button id="toggleMeasurementBtn" class="custom-button text-gray-500 hover:bg-gray-200">
    <i class="fas fa-ruler-combined"></i>
</button>

    <!-- Botón de capas -->
	
<button id="toggleLayerList"><i class="fas fa-layer-group"></i></button>


<script>
    function closeModal() {
      const modal = document.getElementById("welcomeModal");
      modal.style.display = "none";
    }

    // Mostrar el modal al cargar la página
    window.onload = () => {
      const modal = document.getElementById("welcomeModal");
      modal.style.display = "flex";
    };
</script>


<script>
require([
  "esri/Map", "esri/views/MapView", "esri/widgets/Home", "esri/widgets/Compass", 
  "esri/widgets/Measurement", "esri/widgets/Search", "esri/widgets/BasemapGallery", 
  "esri/Basemap", "esri/widgets/AreaMeasurement2D", "esri/layers/FeatureLayer", 
  "esri/widgets/LayerList", "esri/widgets/Legend", "esri/widgets/Expand"
], function (Map, MapView, Home, Compass, Measurement, Search, BasemapGallery, Basemap, AreaMeasurement2D, FeatureLayer, LayerList, Legend, Expand) {

  const map = new Map({ basemap: "hybrid" });
  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [-89.595, 18.725],
    zoom: 9
  });

  let areaMeasurement;
  let isMeasurementActive = false;
  document.getElementById("toggleMeasurementBtn").addEventListener("click", () => {
    if (isMeasurementActive) {
      view.ui.remove(areaMeasurement);
      areaMeasurement.destroy();
      areaMeasurement = null;
    } else {
      areaMeasurement = new AreaMeasurement2D({ view: view });
      view.ui.add(areaMeasurement, "bottom-left");
    }
    isMeasurementActive = !isMeasurementActive;
  });

  const layers = [
    new FeatureLayer({
      url: "https://services5.arcgis.com/LZ4OoSCijnlgkZex/arcgis/rest/services/CK_Segmentacion_biofisica_tercer_orden/FeatureServer",
      title: "Segmentación Biofísica 3er Orden",
      opacity: 1
    }),
    new FeatureLayer({
      url: "https://services5.arcgis.com/LZ4OoSCijnlgkZex/arcgis/rest/services/CK_Segmentacion_biofisica_cuarto_orden/FeatureServer",
      title: "Segmentación Biofísica 4to Orden",
      opacity: 1
    })
  ];

  layers.forEach(layer => map.add(layer));

  // Función para manejar el clic en el mapa y mostrar los datos de la capa
  view.on("click", async (event) => {
    const screenPoint = { x: event.x, y: event.y };

    // Realiza un hitTest para obtener la entidad seleccionada
    const hitTestResult = await view.hitTest(screenPoint);
    const graphic = hitTestResult.results.find(result => result.graphic);

    if (graphic) {
      const feature = graphic.graphic;
      const layer = feature.layer;

      // Verifica que la capa es una FeatureLayer
      if (layer instanceof FeatureLayer) {
        const objectId = feature.attributes[layer.objectIdField];

        // Realiza una consulta para obtener todos los campos de la entidad
        const query = layer.createQuery();
        query.objectIds = [objectId];
        const featureSet = await layer.queryFeatures(query);

        if (featureSet.features.length > 0) {
          const attributes = featureSet.features[0].attributes;
          const fields = layer.fields;

          // Crea una ventana emergente para mostrar los campos
          const popupContent = document.createElement("div");
          popupContent.innerHTML = `<strong>Detalles de la capa: ${layer.title}</strong><br><br>`;

          // Recorre los atributos y los muestra en la ventana
          fields.forEach(field => {
            const fieldName = field.name;
            const fieldValue = attributes[fieldName];
            popupContent.innerHTML += `<strong>${fieldName}:</strong> ${fieldValue}<br>`;
          });

          // Muestra la ventana emergente
          view.popup.open({
            location: event.mapPoint,
            content: popupContent,
            title: `Detalles de la entidad`
          });
        }
      }
    }
  });

// Crear el LayerList
const layerList = new LayerList({
  view: view,
  listItemCreatedFunction: function(event) {
    const item = event.item;
    const layer = layers.find(l => l.title === item.title);

    // Descripción personalizada
    let description = "";
    if (item.title === "Segmentación Biofísica 3er Orden") {
      description = "Segmentación biofísica a nivel de tercer orden, útil para análisis generales.";
    } else if (item.title === "Segmentación Biofísica 4to Orden") {
      description = "Segmentación biofísica a nivel de cuarto orden, proporcionando mayor detalle.";
    }

    // Control de transparencia
    const opacityControl = document.createElement("input");
    opacityControl.type = "range";
    opacityControl.min = 0;
    opacityControl.max = 1;
    opacityControl.step = 0.1;
    opacityControl.value = layer.opacity;
    opacityControl.style.width = "100%";

    // Evento para actualizar la transparencia de la capa
    opacityControl.addEventListener("input", function() {
      layer.opacity = parseFloat(opacityControl.value);
    });

    // Crear panel de simbología
    const legend = new Legend({
      view: view,
      layerInfos: [{ layer: layer, title: "" }]
    });

    // Contenedor del panel
    const panelContainer = document.createElement("div");
    panelContainer.innerHTML = `<strong>Descripción:</strong><br>${description}<br><br>`;
    panelContainer.appendChild(opacityControl);
    panelContainer.innerHTML += `<br><strong>Simbología:</strong><br>`;
    
    // Insertar la leyenda en el mismo panel
    legend.container = panelContainer;

    item.panel = {
      content: panelContainer,
      open: true
    };
  }
});

// Añadir el LayerList a la vista
view.ui.add(layerList, "top-right");

// Ocultar el LayerList por defecto
layerList.visible = false;

// Botón para ocultar/mostrar el LayerList
const toggleButton = document.getElementById("toggleLayerList");
toggleButton.addEventListener("click", function() {
  layerList.visible = !layerList.visible;
});


  const compass = new Compass({ view });
  view.ui.add(compass, "top-left");

  const homeWidget = new Home({ view });
  view.ui.add(homeWidget, "top-left");

  const basemapGallery = new BasemapGallery({
    view: view,
    container: document.getElementById("basemapSelector")
  });

  function toggleBasemapGallery() {
    const basemapSelector = document.getElementById("basemapSelector");
    basemapSelector.style.display = basemapSelector.style.display === 'none' ? 'block' : 'none';
  }

  function setBasemap(basemapId) {
    map.basemap = new Basemap({ id: basemapId });
    toggleBasemapGallery();
  }

  function printMap() {
    view.when(() => {
      view.takeScreenshot().then((screenshot) => {
        const printMapImg = document.getElementById("printMap");
        printMapImg.src = screenshot.dataUrl;
        document.getElementById("printMapContainer").classList.add("print-map");
        setTimeout(() => {
          window.print();
          document.getElementById("printMapContainer").classList.remove("print-map");
        }, 1000);
      });
    });
  }

  function shareMap() {
    const mapUrl = window.location.href;
    const shareText = `¡Mira este mapa! ${mapUrl}`;
    if (navigator.share) {
      navigator.share({ title: 'Mapa de ArcGIS', text: shareText, url: mapUrl }).catch(console.error);
    } else {
      alert('Tu navegador no soporta compartir, copia y pega la URL: ' + mapUrl);
    }
  }

  function toggleContactForm() {
    const form = document.getElementById('contactForm');
    form.style.display = form.style.display === 'none' ? 'flex' : 'none';
  }

  function sendEmail() {
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const comments = document.getElementById('comments').value;
    window.location.href = `mailto:geovanni.agorea@gmail.com?subject=Contacto desde el mapa&body=Nombre: ${name}\nCorreo: ${email}\nComentarios:\n${comments}`;
    toggleContactForm();
  }

  view.on("pointer-move", (event) => {
    const latLon = view.toMap({ x: event.x, y: event.y });
    document.getElementById("coordinatesText").innerHTML = `Lat: ${latLon.latitude.toFixed(4)}, Lon: ${latLon.longitude.toFixed(4)}`;
  });

  view.watch("scale", (newValue) => {
    document.getElementById("scaleText").innerHTML = `Escala: 1:${Math.round(newValue)}`;
  });

  window.printMap = printMap;
  window.shareMap = shareMap;
  window.toggleContactForm = toggleContactForm;
  window.sendEmail = sendEmail;
  window.toggleBasemapGallery = toggleBasemapGallery;
  window.setBasemap = setBasemap;
});



</script>

    

</body>
</html>
